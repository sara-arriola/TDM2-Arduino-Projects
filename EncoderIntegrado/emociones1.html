<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel de composici√≥n - demo</title>
<style>
  :root{
    --bg:#f3f3f6;
    --panel:#ececf0;
    --card:#d9d9de;
    --accent:#f9f9fb;
    --highlight:#f9d3ff;
    --muted:#9b9ba6;
  }
  body{ margin:0; font-family:Inter,system-ui,Arial; background-image: url(Dise√±o/Frame\ 4.png); color:#222; 
  background-size: cover;
  }
  .container{
    max-width: 100%;
    height: 90vh;
    display: flex;
    background:#ffffff00;
    padding:20px;
    align-items: center;
    justify-content: center;
  }

  .container2{
    box-shadow:0 6px 24px rgba(0,0,0,0.08);
    display:flex;
    gap:18px;
    background-image: url(Dise√±o/Frame\ 3.png);
    background-size: cover;
    padding-top: 60px;
    align-items:center;
    justify-content: center;
    width: 130vh;
    border-radius: 10px;
    height: 60vh;
  }

  .grid-panel{
    background: #56303000;
    padding:16px;
    border-radius:8px;
    overflow:hidden;
    position:relative;
  }
  .pad-grid{
    display:grid;
    grid-template-columns: repeat(3,1fr);
    grid-auto-rows: 95px;
    gap:12px;
    user-select:none;
    height:calc(100% - 28px);
  }
  .pad{
    border-radius:20px;
    background:linear-gradient(180deg,#e6e6eb,#dcdce3);
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    transition:transform .12s ease, box-shadow .12s ease, background .12s;
    cursor:pointer;
    box-shadow: inset 0 -4px 0 rgba(0,0,0,0.03);
    width: 90px;
    height: 90px;
    font-size: 0px;
  }
  .pad:active{ transform:scale(.995); }
  .pad.cursor{
    outline:4px solid rgba(255, 255, 255, 0.511);
    transform: translateY(-3px);
    box-shadow:0 8px 20px rgba(43,124,255,0.12);
  }
  .pad.selected{
    background:linear-gradient(180deg,#ffffff,#eaf3ff);
    border:4px solid var(--highlight);
    transform: scale(1.02);
  }

  .composer-panel{
    background:#815f5f00;
    border-radius:8px;
    box-shadow: inset 0 1px 0 rgba(0,0,0,0.02);
    width: 60%;
    height: 60vh;
  }
  .stack{
    margin-top:8px;
    border-radius:8px;
    padding:12px;
    background:#22222200;
  }
  .stack-item{
    display:flex;
    justify-content:space-between;
    align-items:self-start;
    max-width: 100%;
    padding:10px;
    border-radius:6px;
    background:#ffffffc6;
    box-shadow:0 2px 6px rgba(0,0,0,0.03);
    margin-bottom:8px;
    height: 10vh;
  }
  .stack-item .meta{ font-size:13px; color:#222; }
  .stack-item .btn{ background:#f2f2f6; padding:6px 8px; border-radius:6px; cursor:pointer; font-size:13px; color:#444; border:none; }

  .rightbar{
    background: #00000000;
    padding:14px;
    border-radius:8px;
    width: 25vh;
    height:560px;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:center;
    justify-content:center;
  }
  .rightbar img{
    width: 115px;
    border-radius:10px;
    transition:transform .15s, box-shadow .15s;
  }
  .rightbar img.focused{
    outline:4px solid rgba(255,255,255,0.7);
    transform:scale(1.05);
    box-shadow:0 8px 20px rgba(0,0,0,0.25);
  }

  .barra{
    position: absolute;
    background-image: url(Dise√±o/barra\ de\ abajo.png);
    width: 100%;
    height: 10vh;
    top: 90vh;
  }

  .player{
    width: 130vh;
    background-color: #99b7c3da;
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
    height: 10vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .player img{
    width: 30vh;
    margin-left: 3vh;
  }

  .all{
    display: flex;
    flex-direction: column;
    width: 130vh;
    gap: 0 !important;
    padding: 0 !important;
  }

  @media (max-width:980px){
    .container{ grid-template-columns:1fr; padding:10px; }
    .rightbar{ order:3; height:auto; flex-direction:row; justify-content:space-around; }
  }

  /* =========== OVERLAY INTRO =========== */
#introOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999999; /* encima de TODO */
}

#introOverlay img {
  max-width: 90vw;
  max-height: 90vh;
  object-fit: contain;
}

/* --- NUEVO ESTILO PARA LAS OPCIONES NO SELECCIONADAS EN LA MISMA FILA --- */
.pad.desaturated {
    filter: grayscale(80%) brightness(85%); /* Desatura un 80% y oscurece un poco */
    opacity: 0.7;
    transition: filter .2s ease, opacity .2s ease;
}

</style>
</head>
<body>

<div class="container" tabindex="0">
  <div class="all">
    <div class="container2" tabindex="0">
      <div class="grid-panel" id="gridPanel">
        <div class="pad-grid" id="padGrid" aria-label="Grid de instrumentos"></div>
      </div>
      <div class="composer-panel" aria-live="polite">
        <div class="stack" id="stackArea">
          <div style="color:var(--muted); font-size:0px;">Pistas seleccionadas (apiladas):</div>
        </div>
      </div>
    </div>

    <div class="player">
      <div class="wire-btn circle" title="play/stop"></div>
      <img src="Dise√±o/barra reproductor.png" alt="">
    </div>
  </div>

  <aside class="rightbar" id="rightBar">
    <div><a href="#"><img src="" alt=""></a></div>
    <div><a href="Nucleo1.html"><img src="Dise√±o/Frame 4 (1).png" alt=""></a></div>
    <div><a href="Nucleo2.html"><img src="Dise√±o/Frame 5.png" alt=""></a></div>
    <div><a href="index2.html"><img src="Dise√±o/Frame 6.png" alt=""></a></div>
  </aside>
</div>

<div class="barra"></div>

<!-- =========================
     OVERLAY DE INSTRUCCIONES
========================== -->
<div id="introOverlay">
  <img id="introImage" src="Dise√±o/LOOP1.png" alt="">
</div>

<div id="finalOverlay" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999999999;
  flex-direction: column; /* A√±ade esto para apilar el texto y la imagen verticalmente */
  gap: 20px; /* Espacio entre el texto y la imagen */
">
  <p id="qrMessage" style="color: white; font-size: 24px; text-align: center; font-weight: bold;"></p> <img id="finalImage" src="Dise√±o/LOOP5.png" style="max-width:80%; height:auto;">
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Usa un peque√±o retraso para asegurar que la ventana padre (index.html)
        // haya expuesto correctamente su objeto 'arduino' (app) al iframe.
        setTimeout(() => {
            try {
                // Acceder al objeto 'arduino' (expuesto como 'app' en main.js de la ventana padre)
                const parentApp = window.parent.app;
                
                if (parentApp && typeof parentApp.setNucleo === 'function') {
                    // LLAMADA CRUCIAL: Establece el estado del N√∫cleo a 3
                    parentApp.setNucleo(3); 
                    console.log("Estado del N√∫cleo enviado: 3");
                } else {
                    console.warn("Advertencia: No se encontr√≥ la funci√≥n setNucleo en la ventana padre. La conexi√≥n serial puede no estar activa.");
                }
            } catch (e) {
                console.error("Error al acceder a la ventana padre para establecer el n√∫cleo:", e);
            }
        }, 100);
    });
</script>

<script>
    // === RECEPTOR DE MENSAJES DEL ARDUINO ===
    window.addEventListener('message', (evento) => {
        // 1. Verificamos que sea nuestro mensaje
        if (evento.data && evento.data.tipo === 'ENCODER_BITIA') {
            
            const direccion = evento.data.dir; // "CW" o "CCW"
            // console.log("Recibido en iframe:", direccion); // Descomentar para debug

            // 2. Convertimos la direcci√≥n en matem√°ticas (+1 o -1)
            const delta = (direccion === "CW") ? 1 : -1;

            // 3. APLICAMOS LA L√ìGICA SEG√öN EL MODO
            
            if (typeof mode !== 'undefined') { 

                if (mode === 'grid') {
                    // Mover en la grilla (Horizontalmente, igual que el mouse)
                    currentCol = clampMod(currentCol + delta, COLS);
                    
                    // üî• ESTO FALTABA DESCOMENTAR: Actualizar visualmente la grilla
                    updateCursor(); 
                    
                } else if (mode === 'rightbar') {
                    // Mover en la barra lateral
                    rightBarIndex = clampMod(rightBarIndex + delta, rightBarImgs.length);
                    
                    // Actualizar visualmente la barra
                    updateRightbarFocus(); 
                }
            } 
        }
    });
</script>

<script>
    let blockZAction = false;
    let isIntroActive = true; // Empieza como activa
const padGrid = document.getElementById('padGrid');
const stackArea = document.getElementById('stackArea');
const rightBar = document.getElementById('rightBar');
let rightBarImgs = rightBar.querySelectorAll('img'); // Cambiado a 'let' para reasignaci√≥n

const ROWS = 4, COLS = 3;
let currentRow = 0, currentCol = 0;
let mode = 'grid'; // "grid" o "rightbar"
let rightBarIndex = 0;

const labels = [
    ['Guitarra 1','Guitarra 2','Guitarra 3'],
    ['Bateria 1','Bateria 2','Bateria 3'],
    ['Piano 1','Piano 2','Piano 3'],
    ['Voz 1','Voz 2','Voz 3']
];

let audioCtx = null;
function ensureAudio(){ if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); } }

const selected=[null,null,null,null];
const padImages=[
    ['Dise√±o/Property 1=Frame 21.png','Dise√±o/Property 1=Frame 23.png','Dise√±o/Property 1=Frame 25.png'],
    ['Dise√±o/Property 1=Frame 27.png','Dise√±o/Property 1=Frame 29.png','Dise√±o/Property 1=Frame 31.png'],
    ['Dise√±o/Property 1=Frame 15.png','Dise√±o/Property 1=Frame 17.png','Dise√±o/Property 1=Frame 19.png'],
    ['Dise√±o/Property 1=Frame 9.png','Dise√±o/Property 1=Frame 11.png','Dise√±o/Property 1=Frame 13.png']
];

// ----------------------------------------------------------------------
// NUEVAS FUNCIONES PARA EL BOT√ìN "TERMINAR"
// ----------------------------------------------------------------------

// 1. Verifica si todas las 4 pistas tienen un instrumento seleccionado
function checkCompletion() {
    // Retorna true si todos los elementos de 'selected' son no nulos
    return selected.every(selection => selection !== null);
}

// 2. Actualiza la visibilidad del bot√≥n "Terminar"
// 2. Actualiza la visibilidad del bot√≥n "Terminar"
function updateFinishButton() {
    const isCompleted = checkCompletion();
    let finishBtn = document.getElementById('finish-img');
    let finishLink = document.getElementById('finish-link');
    let finishWrapper = document.getElementById('finish-btn-wrapper');

    // Crea el elemento si no existe
    if (!finishBtn) {
        finishWrapper = document.createElement('div');
        finishWrapper.id = 'finish-btn-wrapper';
        finishWrapper.style.display = 'none';
        
        finishLink = document.createElement('a');
        finishLink.href = 'Final.html';
        finishLink.id = 'finish-link';
        finishLink.title = 'Terminar Composici√≥n';
        
        // El contenedor DIV en el rightbar necesita un ancho o flex-basis
        // para asegurar que toma espacio, aunque tu CSS ya maneja el tama√±o de la imagen.
        
        finishBtn = document.createElement('img');
        
        // ‚≠ê‚≠ê ASEG√öRATE QUE ESTA RUTA ES CORRECTA ‚≠ê‚≠ê
        finishBtn.src = 'Dise√±o/Frame_21(2).png'; 
        finishBtn.alt = 'Terminar';
        finishBtn.id = 'finish-img';
        
        // A√±adir evento de clic para el bot√≥n creado din√°micamente (para mouse)
        finishLink.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = finishLink.getAttribute('href');
        });

        finishLink.appendChild(finishBtn);
        finishWrapper.appendChild(finishLink);
        rightBar.appendChild(finishWrapper);
    }
    
    // Muestra u oculta el bot√≥n
    if (isCompleted) {
        finishWrapper.style.display = 'block'; 
        // Nota: El 'div' se muestra, y la imagen dentro toma el estilo '.rightbar img'.
    } else {
        finishWrapper.style.display = 'none';
    }
    
    // Vuelve a obtener la lista de im√°genes, incluyendo la nueva si existe
    rightBarImgs = rightBar.querySelectorAll('img');

    // Si el √≠ndice enfocado actual es el bot√≥n "Terminar" y este se oculta, reinicia el foco.
    if (!isCompleted && rightBarIndex >= rightBarImgs.length) {
        rightBarIndex = 0;
        updateRightbarFocus();
    }
}

// ----------------------------------------------------------------------
// FUNCIONES EXISTENTES MODIFICADAS (A√±adiendo updateFinishButton)
// ----------------------------------------------------------------------

/* ======================================================
   SISTEMA DE 4 IM√ÅGENES DE INSTRUCCIONES (LOOP1 ‚Üí LOOP4)
   Pasan tocando CUALQUIER tecla
====================================================== */

const introImages = ["Dise√±o/LOOP1.png", "Dise√±o/LOOP2.png", "Dise√±o/LOOP3.png", "Dise√±o/LOOP4.png"];
let introIndex = 0;

const introOverlay = document.getElementById("introOverlay");
const introImage = document.getElementById("introImage");

function nextIntroImage(e) { // <-- Aseguramos que recibe el evento 'e'
    // Si la intro ya termin√≥, no hagas nada
    if (!isIntroActive) return; 

    introIndex++;

    // Si a√∫n quedan im√°genes ‚Üí cambiar a la siguiente
    if (introIndex < introImages.length) {
        introImage.src = introImages[introIndex];
    } 
    // Si se terminaron ‚Üí ocultar overlay y habilitar la web
    else {
        introOverlay.style.display = "none";
        
        // Detenemos el listener
        window.removeEventListener("keydown", nextIntroImage, true); // ‚≠ê ¬°IMPORTANTE! Quitar tambi√©n en fase de captura
        
        // Ahora la aplicaci√≥n est√° activa.
        isIntroActive = false; 

        // ‚≠ê ¬°CRUCIAL! Detener la propagaci√≥n.
        // Como estamos en la fase de captura, este evento no llegar√° al otro listener de keydown.
        if (e && typeof e.stopImmediatePropagation === 'function') {
             e.stopImmediatePropagation();
        }
    }
}

// En cuanto se toca cualquier tecla ‚Üí pasar imagen.
// Usamos 'true' para la fase de CAPTURA para asegurar que se ejecute antes que el listener principal.
window.addEventListener("keydown", nextIntroImage, true);

// --- CONTROLES PARA LOOP5 ---
// --- CONTROLES PARA LOOP5 ---
window.addEventListener("keydown", async (e) => {
    if (!showingFinalPrompt) return;

    const key = e.key.toLowerCase();

    // Opci√≥n 1 ‚Üí reproducir 20 segundos y terminar
    if (key === "-") {
    hideFinalPrompt();
    await playTwentySecondsThenFinish(); // Al terminar llama a showQRResult()
    e.preventDefault();
}


    // Opci√≥n Z ‚Üí volver a editar
    if (key === "z") {
        hideFinalPrompt();
        // ‚≠ê BLOQUEO: Activa el bloqueo e impide que el keyup haga la deselecci√≥n
        blockZAction = true;
        // ‚≠ê Detener la propagaci√≥n para que el keyup principal no se ejecute
        e.stopImmediatePropagation();
        e.preventDefault();
    }
}, true); // Usar fase de captura (true) o stopImmediatePropagation.

// =========================================================
// MOSTRAR EL QR CORRECTO DESPU√âS DE LOOP5
// =========================================================
function showQRResult() { 
    const finalImg = document.getElementById("finalImage");
    const qrMessage = document.getElementById("qrMessage");
    
    // Obtener el nuevo √≠ndice de QR (0 a 27)
    const { qrIndex } = getSongIndex(); 

    // Establecer el texto del mensaje
    qrMessage.textContent = "Escanea el QR para descargar tu canci√≥n";

    // El primer QR (√≠ndice 0) debe ser Untitled(27). 
    // Por lo tanto, sumamos 27 al √≠ndice: 0 + 27 = 27, 27 + 27 = 54.
    const fileNumber = qrIndex + 27;

    // Nombre del archivo: Untitled(27).png, ... Untitled(54).png (si qrIndex=27)
    finalImg.src = `QR/Untitled (${fileNumber}).png`;

    // Mantener overlay visible con el QR final
    document.getElementById("finalOverlay").style.display = "flex";
    document.getElementById("finalImage").style.width = "250px";

    // ‚≠ê‚≠ê REDIRECCI√ìN AUTOM√ÅTICA DESPU√âS DE 25 SEGUNDOS ‚≠ê‚≠ê
    setTimeout(() => {
        // Redirige a la p√°gina principal (nucleo11.html)
        window.location.href = 'nucleo11.html';
    }, 25000); // 25000 milisegundos = 25 segundos
}
// Variable global para el audio de la canci√≥n pregrabada

// Variable global para el audio de la canci√≥n pregrabada
let currentSongAudio = null;

async function playTwentySecondsThenFinish() {
    ensureAudio();

    // 1. Obtener la ruta de la canci√≥n pregrabada y el √≠ndice del QR
    // Ya no se usa 'qrIndex' aqu√≠, solo 'songPath'
    const { songPath } = getSongIndex(); 

    // 2. üõë DETENER TODOS LOS LOOPS Y LA INTERFAZ DE REPRODUCCI√ìN GLOBAL
    // ... (El resto de la l√≥gica de detenci√≥n es la misma)

    // Detener y limpiar cualquier loop de instrumento que est√© sonando
    for (let r = 0; r < ROWS; r++) {
        if (selected[r]?.nodeObj?.audio) {
            selected[r].nodeObj.audio.pause();
            selected[r].nodeObj.audio.currentTime = 0;
        }
    }

    // Asegurar que el bot√≥n de Play/Pause global se detenga y muestre 'Play'
    const playButton = document.querySelector('.wire-btn.circle');
    isPlaying = false;
    playButton.textContent = '‚ñ∂Ô∏è';

    // Detener y limpiar la canci√≥n anterior si existe (si se pulsa '1' varias veces)
    if (currentSongAudio) {
        currentSongAudio.pause();
        currentSongAudio.currentTime = 0;
        currentSongAudio = null;
    }

    // 3. Cargar y reproducir la nueva canci√≥n
    currentSongAudio = new Audio(songPath);
    currentSongAudio.volume = 0.6; // Volumen deseado

    await currentSongAudio.play().catch(e => {
        console.warn("Error al intentar reproducir el audio de la canci√≥n:", e);
    });

    // 4. Esperar 20 segundos
    await new Promise(res => setTimeout(res, 20000));

    // 5. Detener la canci√≥n pregrabada
    if (currentSongAudio) {
        currentSongAudio.pause();
        currentSongAudio.currentTime = 0;
    }

    // 6. Mostrar QR correcto (showQRResult llama internamente a getSongIndex() para el √≠ndice de QR)
    showQRResult();
}

// =========================================================
// DEFINICI√ìN DE GRUPOS DE CANCIONES Y L√ìGICA DE √çNDICES
// =========================================================

// Grupos de canciones pregrabadas (RUTA Y NOMBRE A VERIFICAR)
// Grupo 1: Voz 1 (10 canciones)
const group1Songs = [
    'Canciones/cancionG1-1.mp3', 'Canciones/cancionG1-2.mp3', 'Canciones/cancionG1-3.mp3', 'Canciones/cancionG1-4.mp3', 'Canciones/cancionG1-5.mp3',
    'Canciones/cancionG1-6.mp3', 'Canciones/cancionG1-7.mp3', 'Canciones/cancionG1-8.mp3', 'Canciones/cancionG1-9.mp3', 'Canciones/cancionG1-10.mp3',
]; // Total: 10 canciones (√çndice: 0-9)

// Grupo 2: Voz 2 (8 canciones)
const group2Songs = [
    'Canciones/cancionG2-1.mp3', 'Canciones/cancionG2-2.mp3', 'Canciones/cancionG2-3.mp3', 'Canciones/cancionG2-4.mp3',
    'Canciones/cancionG2-5.mp3', 'Canciones/cancionG2-6.mp3', 'Canciones/cancionG2-7.mp3', 'Canciones/cancionG2-8.mp3',
]; // Total: 8 canciones (√çndice: 0-7)

// Grupo 3: Voz 3 (10 canciones)
const group3Songs = [
    'Canciones/cancionG3-1.mp3', 'Canciones/cancionG3-2.mp3', 'Canciones/cancionG3-3.mp3', 'Canciones/cancionG3-4.mp3', 'Canciones/cancionG3-5.mp3',
    'Canciones/cancionG3-6.mp3', 'Canciones/cancionG3-7.mp3', 'Canciones/cancionG3-8.mp3', 'Canciones/cancionG3-9.mp3', 'Canciones/cancionG3-10.mp3',
]; // Total: 10 canciones (√çndice: 0-9)

// Arreglo maestro para acceder f√°cilmente
const songGroups = [group1Songs, group2Songs, group3Songs];

// =========================================================
// CALCULAR EL N√öMERO DE QR SEG√öN LA COMBINACI√ìN SELECCIONADA
// Orden lexicogr√°fico: fila1->fila2->fila3->fila4
// Cada fila aporta: col * 3^(fila)
// =========================================================


// Calcula el √≠ndice de la canci√≥n DENTRO de su grupo (depende de Guitarra, Bater√≠a, Piano)
// =========================================================
// CALCULA EL √çNDICE DE LA CANCI√ìN Y EL √çNDICE DEL QR
// =========================================================
function getSongIndex() {
    // 1. Calcular el √≠ndice de combinaci√≥n de los primeros 3 instrumentos (0 a 26)
    let totalIndex = 0;
    totalIndex += selected[0].col * 1; // Guitarra (0, 1, 2)
    totalIndex += selected[1].col * 3; // Bater√≠a (0, 3, 6)
    totalIndex += selected[2].col * 9; // Piano (0, 9, 18)

    // 2. Determinar el grupo y el √≠ndice de la canci√≥n DENTRO del grupo
    const voiceCol = selected[3].col; // 0, 1, o 2
    const songGroup = songGroups[voiceCol];
    const groupSize = songGroup.length; // 10, 8, o 10
    
    // √çndice dentro del grupo (0 a 9, 0 a 7, o 0 a 9)
    const songIndexInGroup = totalIndex % groupSize; 

    // 3. Determinar la RUTA FINAL del QR (√çndice acumulado de 0 a 27)
    let qrIndex = 0;

    if (voiceCol === 0) { // Grupo 1 (Voz 1): 10 canciones
        // QR de 0 a 9 (Total 10)
        qrIndex = songIndexInGroup;
    } else if (voiceCol === 1) { // Grupo 2 (Voz 2): 8 canciones
        // QR de 10 a 17 (Total 8). Empieza despu√©s de los 10 primeros.
        qrIndex = 10 + songIndexInGroup;
    } else if (voiceCol === 2) { // Grupo 3 (Voz 3): 10 canciones
        // QR de 18 a 27 (Total 10). Empieza despu√©s de 10 + 8 = 18.
        qrIndex = 18 + songIndexInGroup;
    }
    
    // El √≠ndice total de QR es (0-9) + (10-17) + (18-27) = 28 QR.

    return {
        songPath: songGroup[songIndexInGroup], // Ruta de la canci√≥n
        qrIndex: qrIndex // √çndice del QR (0 a 27)
    };
}

function buildGrid(){
    padGrid.innerHTML='';
    for(let r=0;r<ROWS;r++){
        for(let c=0;c<COLS;c++){
            const el=document.createElement('div');
            el.className='pad';
            el.style.backgroundImage=`url('${padImages[r][c]}')`;
            el.style.backgroundSize='cover';
            el.style.backgroundPosition='center';
            el.dataset.row=r; el.dataset.col=c;
            el.innerHTML=`<div class="label">${labels[r][c]}</div>`;
            el.addEventListener('click',()=>{ currentRow=r; currentCol=c; updateCursor(); selectCurrent(); });
            padGrid.appendChild(el);
        }
    }
    updateCursor(); refreshSelectionsUI();
    updateFinishButton(); // <--- A√ëADIDO
}

function getPadElement(row,col){ return padGrid.children[row*COLS+col]; }

function updateCursor(){
    Array.from(padGrid.children).forEach(el=>el.classList.remove('cursor'));
    if(mode==='grid'){
        const el=getPadElement(currentRow,currentCol);
        if(el) el.classList.add('cursor');
    }
}

function clampMod(v,mod){ return ((v%mod)+mod)%mod; }

// --- Scroll para grid y rightbar ---
window.addEventListener('wheel', e => {
    if (mode === 'grid') {
        e.preventDefault();
        currentCol = clampMod(currentCol + (e.deltaY > 0 ? 1 : -1), COLS);
        updateCursor();
    } else if (mode === 'rightbar') {
        e.preventDefault();
        rightBarIndex = clampMod(rightBarIndex + (e.deltaY > 0 ? 1 : -1), rightBarImgs.length);
        updateRightbarFocus();
    }
}, { passive: false });


function updateRightbarFocus(){
    rightBarImgs.forEach((img,i)=>{
        img.classList.toggle('focused', i===rightBarIndex);
    });
}

let jTimeout = null;
let jLongPress = false;
const jHoldThreshold = 2000; // 2 segundos

window.addEventListener('keydown', e => {
    // üõë ¬°NUEVA VERIFICACI√ìN CRUCIAL! üõë
    if (isIntroActive) return; 
    // Si la introducci√≥n est√° activa, ignora todas las dem√°s teclas (z, x, 1, }, k, etc.)

    const key = e.key.toLowerCase();

    // --- Play/Pause con la tecla '1' ---
    if (key === '-' && !e.repeat) {
        document.querySelector('.wire-btn.circle').click();
        e.preventDefault();
    }

    // --- J largo: alternar grid / rightbar ---
    if (key === '+' && !jTimeout) {
        // ... (resto de la l√≥gica de jTimeout)
        jLongPress = false;
        jTimeout = setTimeout(() => {
            jLongPress = true;

            // Alternar modo
            mode = (mode === 'grid') ? 'rightbar' : 'grid';
            updateCursor();
            updateRightbarFocus();

            jTimeout = null;
        }, jHoldThreshold);
    }

    // --- Alternar modo con X ---
    if (key === 'x') {
        mode = (mode === 'grid') ? 'rightbar' : 'grid';
        updateCursor();
        updateRightbarFocus();
    }

    // --- Navegaci√≥n ---
    if (mode === 'grid') {
        if (key === '8') { currentRow = clampMod(currentRow + 1, ROWS); updateCursor(); }
        else if (key === '0') { currentRow = clampMod(currentRow - 1, ROWS); updateCursor(); }
    } else if (mode === 'rightbar') {
        // La longitud de rightBarImgs.length se actualiza en updateFinishButton
        if (key === '8') { rightBarIndex = clampMod(rightBarIndex + 1, rightBarImgs.length); updateRightbarFocus(); }
        else if (key === '0') { rightBarIndex = clampMod(rightBarIndex - 1, rightBarImgs.length); updateRightbarFocus(); }
    }
});


window.addEventListener('keyup', e => {
    if (isIntroActive) return;

    // ‚≠ê Si la acci√≥n fue bloqueada por salir de LOOP5, saltamos la l√≥gica de Z
    if (blockZAction) {
        blockZAction = false; // Desactivar el bloqueo
        return; 
    }


    const key = e.key.toLowerCase();

    if (key === '+') {
        if (jTimeout) {
            clearTimeout(jTimeout);
            jTimeout = null;
        }

        // --- Acci√≥n corta solo si no fue J largo ---
        if (!jLongPress) {
            if (mode === 'grid') selectCurrent();
            else if (mode === 'rightbar') {
                const target = rightBarImgs[rightBarIndex];
                if (!target) return;
                const parentLink = target.closest('a');
                
                // Si tiene un 'href' (incluido el nuevo bot√≥n Terminar con 'fin.html'), navega.
                if (parentLink && parentLink.getAttribute('href') && parentLink.getAttribute('href') !== '#') {
                    window.location.href = parentLink.getAttribute('href');
                } else {
                    activateRightbarItem();
                }
            }
        }
    }
});


function activateRightbarItem(){
    const target=rightBarImgs[rightBarIndex];
    if(!target) return;
    // Acci√≥n de ejemplo (si no es un enlace de navegaci√≥n)
    console.log('Seleccionaste:', target.src);
    target.style.transform='scale(1.2)';
    setTimeout(()=>updateRightbarFocus(),200);
}


async function selectCurrent(){
    // ... (c√≥digo existente) ...

    const row=currentRow, col=currentCol;
    
    if(selected[row] && selected[row].col===col){ 
        stopSelection(row); 
        refreshSelectionsUI(); 
        refreshGridSelectedMarkers(); 
        updateRowSaturation(row, -1); // <-- A√ëADIDO: Deselecci√≥n, restaurar saturaci√≥n de toda la fila
        return; 
    }
    
    if(selected[row]) stopSelection(row);
    
    const label=labels[row][col];
    const nodeObj=await playToneFor(row,col);
    selected[row]={col,label,nodeObj};
    
    refreshSelectionsUI(); 
    refreshGridSelectedMarkers();
    updateRowSaturation(row, col); // <-- A√ëADIDO: Aplicar desaturaci√≥n a las no seleccionadas

    if (checkAllSelected() && !showingFinalPrompt) {
        showFinalPrompt();
    }
}

// =========================================================
// GESTI√ìN DE SATURACI√ìN PARA PADS NO SELECCIONADOS EN LA FILA
// =========================================================
function updateRowSaturation(row, selectedCol) {
    // Itera sobre las 3 columnas de la fila dada
    for (let c = 0; c < COLS; c++) {
        const el = getPadElement(row, c);
        
        if (!el) continue; // Por si acaso

        // Si la columna actual NO es la seleccionada, desaturamos
        if (c !== selectedCol) {
            el.classList.add('desaturated');
        } 
        // Si es la columna seleccionada, o si selectedCol es -1 (deselecci√≥n), quitamos la desaturaci√≥n
        else {
            el.classList.remove('desaturated');
        }
    }
}

async function playToneFor(row,col){
    const audioFiles=[
        ['Musicas/guitarra1.mp3','Musicas/guitarra2.mp3','Musicas/guitarra3.mp3'],
        ['Musicas/bateria1.mp3','Musicas/bateria3.mp3','Musicas/bateria2.mp3'],
        ['Musicas/piano2.mp3','Musicas/piano3.mp3','Musicas/piano1.mp3'],
        ['Musicas/voz1.m4a','Musicas/voz2.m4a','Musicas/voz3.m4a']
    ];
    const file=audioFiles[row][col];
    const audio=new Audio(file);
    audio.loop=false; audio.volume=0.6;
    
    // Detener TODOS los loops seleccionados ANTES de reproducir el nuevo
    for(let r=0;r<ROWS;r++){
        if(selected[r]?.nodeObj?.audio){ selected[r].nodeObj.audio.pause(); selected[r].nodeObj.audio.currentTime=0; }
    }
    
    // Detener la reproducci√≥n global si estaba activa (bot√≥n Play/Pause)
    const playButton = document.querySelector('.wire-btn.circle');
    isPlaying = false;
    playButton.textContent = '‚ñ∂Ô∏è';
    
    audio.play().catch(()=>{});
    audio.addEventListener('ended',()=>{audio.currentTime=0;}); // Esto es para el efecto de preview
    ensureAudio();
    let audioBuffer=null;
    try{
        const resp=await fetch(file);
        const ab=await resp.arrayBuffer();
        audioBuffer=await audioCtx.decodeAudioData(ab.slice(0));
    }catch(err){ console.warn('No se pudo decodificar:',err); }
    return{audio,audioBuffer,stop:()=>{audio.pause();audio.currentTime=0;},label:labels[row][col]};
}

// ------- Play/Pause global -------
let isPlaying=false;
const playButton=document.querySelector('.wire-btn.circle');
playButton.textContent='‚ñ∂Ô∏è';
playButton.addEventListener('click',()=>{
    ensureAudio();
    if(audioCtx.state==='suspended') audioCtx.resume();
    for(let r=0;r<ROWS;r++){ if(selected[r]?.nodeObj?.audio){ selected[r].nodeObj.audio.pause(); selected[r].nodeObj.audio.currentTime=0; } }
    if(!isPlaying){
        for(let r=0;r<ROWS;r++){ if(selected[r]?.nodeObj?.audio){ const a=selected[r].nodeObj.audio; a.currentTime=0; a.play().catch(()=>{}); } }
        playButton.textContent='‚è∏Ô∏è';
    }else{
        for(let r=0;r<ROWS;r++){ if(selected[r]?.nodeObj?.audio){ selected[r].nodeObj.audio.pause(); } }
        playButton.textContent='‚ñ∂Ô∏è';
    }
    isPlaying=!isPlaying;
});

function drawWaveform(audioBuffer,canvas){
    const ctx=canvas.getContext('2d');
    const width=canvas.width, height=canvas.height;
    ctx.clearRect(0,0,width,height);
    if(!audioBuffer){ ctx.fillText('‚ö†Ô∏è Sin forma de onda',10,20); return; }
    const data=audioBuffer.getChannelData(0);
    const step=Math.ceil(data.length/width);
    const amp=height/2;
    ctx.beginPath();
    for(let i=0;i<width;i++){
        let min=1,max=-1;
        for(let j=0;j<step;j++){ const datum=data[i*step+j]; if(datum<min)min=datum; if(datum>max)max=datum; }
        ctx.lineTo(i,(1+min)*amp); ctx.lineTo(i,(1+max)*amp);
    }
    ctx.strokeStyle='#2e6bf0'; ctx.lineWidth=1; ctx.stroke();
}

function refreshGridSelectedMarkers(){
    Array.from(padGrid.children).forEach(el=>{
        el.classList.remove('selected');
        const r=+el.dataset.row,c=+el.dataset.col;
        if(selected[r] && selected[r].col===c) el.classList.add('selected');
    });
}

function refreshSelectionsUI(){
    while(stackArea.children.length>1) stackArea.removeChild(stackArea.lastChild);
    for(let r=0;r<ROWS;r++){
        if(selected[r]){
            const wrapper=document.createElement('div');
            wrapper.className='stack-item';
            wrapper.style.display='flex';
            wrapper.style.flexDirection='column';
            wrapper.style.gap='6px';

            const top=document.createElement('div');
            top.style.display='flex';
            top.style.justifyContent='space-between';
            top.style.alignItems='center';

            const meta=document.createElement('div');
            meta.className='meta';
            meta.innerHTML=`<strong>${selected[r].label}</strong>`;

            const btn=document.createElement('button');
            btn.className='btn';
            btn.textContent='Quitar';
            btn.addEventListener('click',()=>{ stopSelection(r); refreshSelectionsUI(); refreshGridSelectedMarkers(); });

            top.appendChild(meta); top.appendChild(btn); wrapper.appendChild(top);
            const canvas=document.createElement('canvas'); canvas.width=300; canvas.height=60; wrapper.appendChild(canvas);
            if(selected[r].nodeObj?.audioBuffer){ drawWaveform(selected[r].nodeObj.audioBuffer,canvas); }
            stackArea.appendChild(wrapper);
        }
    }
    refreshGridSelectedMarkers();
    // updateFinishButton(); // No es necesario aqu√≠ si selectCurrent y stopSelection lo llaman.
}

function stopSelection(row){ 
    if(!selected[row])return; 
    try{selected[row].nodeObj.stop();}catch(e){} 
    selected[row]=null; 
    
    // ‚≠ê [SOLUCI√ìN] Solo quitamos el gris de la fila que acabamos de deseleccionar.
    // Las otras filas permanecen con sus pads no elegidos en gris, como se desea.
    updateRowSaturation(row, -1); 
    
    updateFinishButton(); // Debe refrescar el bot√≥n "Terminar"

    if (showingFinalPrompt) hideFinalPrompt();
}


buildGrid();
document.querySelector('.container').addEventListener('click',()=>document.querySelector('.container').focus());
updateRightbarFocus();


let showingFinalPrompt = false;

function checkAllSelected() {
    return selected.every(s => s !== null);
}

async function showFinalPrompt() {
    showingFinalPrompt = true;

    // 1. Detener TODO lo que est√© sonando
    for (let r = 0; r < ROWS; r++) {
        if (selected[r]?.nodeObj?.audio) {
            selected[r].nodeObj.audio.pause();
            selected[r].nodeObj.audio.currentTime = 0;
        }
    }

    // 2. Reproducir SOLO el √∫ltimo instrumento seleccionado
    let lastRow = -1;
    for (let r = ROWS - 1; r >= 0; r--) {
        if (selected[r]) {
            lastRow = r;
            break;
        }
    }

    if (lastRow !== -1) {
        const lastAudio = selected[lastRow].nodeObj.audio;
        lastAudio.currentTime = 0;
        lastAudio.play().catch(() => {});
    }

    // 3. Esperar 5 segundos
    await new Promise(res => setTimeout(res, 5000));

    // 4. Detener absolutamente todo
    for (let r = 0; r < ROWS; r++) {
        if (selected[r]?.nodeObj?.audio) {
            selected[r].nodeObj.audio.pause();
            selected[r].nodeObj.audio.currentTime = 0;
        }
    }

    // 5. Mostrar LOOP5
    document.getElementById("finalOverlay").style.display = "flex";
    
}

function hideFinalPrompt() {
    showingFinalPrompt = false;
    document.getElementById("finalOverlay").style.display = "none";
}
</script>

<script>
  window.addEventListener('keydown', (e) => {
    const key = e.key.toLowerCase();
    
    // Si la tecla presionada es 'e'
    if (key === 'e') {
        // Redirige a la p√°gina principal
        window.location.href = 'nucleo11.html';
    }
});
</script>
</body>
</html>

