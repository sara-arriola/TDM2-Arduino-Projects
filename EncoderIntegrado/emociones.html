<!-- J = Z SELECCIONAR
 A = 1 IR PARA ABAJAJO
 D = V IR PARA ARRIBA
 PLAY (sin tecla) = { PLAY-->

<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel de composición - demo</title>
<style>
  :root{
    --bg:#f3f3f6;
    --panel:#ececf0;
    --card:#d9d9de;
    --accent:#f9f9fb;
    --highlight:#f9d3ff;
    --muted:#9b9ba6;
  }
  body{ margin:0; font-family:Inter,system-ui,Arial; background-image: url(Diseño/Frame\ 4.png); color:#222; 
  background-size: cover;
  }
  .container{
    max-width: 100%;
    height: 90vh;
    display: flex;
    background:#ffffff00;
    padding:20px;
    align-items: center;
    justify-content: center;
  }

  .container2{
    box-shadow:0 6px 24px rgba(0,0,0,0.08);
    display:flex;
    gap:18px;
    background-image: url(Diseño/Frame\ 3.png);
    background-size: cover;
    padding-top: 40px;
    align-items:center;
    justify-content: center;
    width: 115vh;
    border-radius: 10px;
    height: 84vh;
  }

  .container2 img{
    width: 110vh;
  }

  .grid-panel{
    background: #56303000;
    padding:16px;
    border-radius:8px;
    overflow:hidden;
    position:relative;
  }
  .pad-grid{
    display:grid;
    grid-template-columns: repeat(3,1fr);
    grid-auto-rows: 95px;
    gap:12px;
    user-select:none;
    height:calc(100% - 28px);
  }
  .pad{
    border-radius:20px;
    background:linear-gradient(180deg,#e6e6eb,#dcdce3);
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    transition:transform .12s ease, box-shadow .12s ease, background .12s;
    cursor:pointer;
    box-shadow: inset 0 -4px 0 rgba(0,0,0,0.03);
    width: 90px;
    height: 90px;
    font-size: 0px;
  }
  .pad:active{ transform:scale(.995); }
  .pad.cursor{
    outline:4px solid rgba(255, 255, 255, 0.511);
    transform: translateY(-3px);
    box-shadow:0 8px 20px rgba(43,124,255,0.12);
  }
  .pad.selected{
    background:linear-gradient(180deg,#ffffff,#eaf3ff);
    border:4px solid var(--highlight);
    transform: scale(1.02);
  }

  .composer-panel{
    background:#815f5f00;
    border-radius:8px;
    box-shadow: inset 0 1px 0 rgba(0,0,0,0.02);
    width: 60%;
    height: 60vh;
  }
  .stack{
    margin-top:8px;
    border-radius:8px;
    padding:12px;
    background:#22222200;
  }
  .stack-item{
    display:flex;
    justify-content:space-between;
    align-items:self-start;
    max-width: 100%;
    padding:10px;
    border-radius:6px;
    background:#ffffffc6;
    box-shadow:0 2px 6px rgba(0,0,0,0.03);
    margin-bottom:8px;
    height: 10vh;
  }
  .stack-item .meta{ font-size:13px; color:#222; }
  .stack-item .btn{ background:#f2f2f6; padding:6px 8px; border-radius:6px; cursor:pointer; font-size:13px; color:#444; border:none; }

  .rightbar{
    background: #00000000;
    padding:14px;
    border-radius:8px;
    width: 25vh;
    height:560px;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:center;
    justify-content:center;
  }
  .rightbar img{
    width: 115px;
    border-radius:10px;
    transition:transform .15s, box-shadow .15s;
  }
  .rightbar img.focused{
    outline:4px solid rgba(255,255,255,0.7);
    transform:scale(1.05);
    box-shadow:0 8px 20px rgba(0,0,0,0.25);
  }

  .barra{
    position: absolute;
    background-image: url(Diseño/barra\ de\ abajo.png);
    width: 100%;
    height: 10vh;
    top: 90vh;
  }

  .player{
    width: 130vh;
    background-color: #99b7c3da;
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
    height: 10vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .player img{
    width: 30vh;
    margin-left: 3vh;
  }

  .all{
    display: flex;
    flex-direction: column;
    width: 130vh;
    gap: 0 !important;
    padding: 0 !important;
  }

  .loop{
    display: none;
    position: absolute;
    margin-top: 40vh;
    margin-right: 10vh;
    top: 0;
    right: 0;
    opacity: 1;
    transition: opacity 0.5s ease;
  }

  .loop img{
    width: 500px;
  }

  .loop.oculto {
  opacity: 0;
  pointer-events: none; /* evita clics mientras se desvanece */
}

  @media (max-width:980px){
    .container{ grid-template-columns:1fr; padding:10px; }
    .rightbar{ order:3; height:auto; flex-direction:row; justify-content:space-around; }
  }


  /* Botón centrado con pulso */
.boton-centro {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  animation: pulso 1.5s infinite ease-in-out;
  cursor: pointer;
  z-index: 20;
}

.boton-centro img {
  width: 160px;
  transition: transform 0.2s ease;
}

/* Animación de pulso */
@keyframes pulso {
  0% { transform: translate(-50%, -50%) scale(1); }
  50% { transform: translate(-50%, -50%) scale(1.12); }
  100% { transform: translate(-50%, -50%) scale(1); }
}

/* Hover visual */
.boton-centro:hover img {
  transform: scale(1.2);
  filter: brightness(1.2);
}


.botones {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 50px;
  position: absolute;
  top: 50%;
  left: 35%;
  transform: translate(-50%, -50%);
}

.botones h1{
  color: #fff;
  font-size: 40px;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);

}

.boton {
  width: 150px;
  transition: transform 0.3s ease, opacity 0.3s ease;
  cursor: pointer;
  opacity: 0.7;
}

.boton.seleccionado {
  transform: scale(1.2);
  opacity: 1;
}

.orden{
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 50px;
}


</style>
</head>
<body>

<div class="container" tabindex="0">
  <div class="all">
    <div class="container2" tabindex="0">
     <img src="Diseño/Frame 7 (2).png" alt="">
    </div>
  </div>

  <aside class="rightbar" id="rightBar">
    <div><a href="#"><img src="" alt=""></a></div>
    <div><a href="Nucleo1.html"><img src="Diseño/Frame 4 (1).png" alt=""></a></div>
    <div><a href="Nucleo2.html"><img src="Diseño/Frame 5.png" alt=""></a></div>
    <div><a href="index2.html"><img src="Diseño/Frame 6.png" alt=""></a></div>
  </aside>
</div>

<div class="barra"></div>

<div class="loop" id="mensaje">
  <img src="Diseño/Frame 18 (2).png" alt="">
</div>

<div class="botones">
  <h1>Como te sentis</h1>
  <div class="orden">
    <div><a href="#"><img src="" alt=""></a></div>
    <img src="Diseño/Frame 18 (3).png" id="btn1" class="boton" alt="Emoción 1">
  <img src="Diseño/Frame 20.png" id="btn2" class="boton" alt="Emoción 2">
  <img src="Diseño/Frame 19 (1).png" id="btn3" class="boton" alt="Emoción 3">
  </div>
  
</div>
<script>
    // === RECEPTOR DE MENSAJES DEL ARDUINO (CORREGIDO PARA EMOCIONES) ===
    window.addEventListener('message', (evento) => {
        // 1. Verificamos que sea nuestro mensaje del Index
        if (evento.data && evento.data.tipo === 'ENCODER_BITIA') {
            
            const direccion = evento.data.dir; // Recibimos "CW" o "CCW"
            
            // 2. Convertimos a +1 (bajar/derecha) o -1 (subir/izquierda)
            const delta = (direccion === "CW") ? 1 : -1;

            // 3. APLICAMOS LA LÓGICA (Copia exacta de tu evento 'wheel')
            
            // Verificamos que las instrucciones no estén tapando la pantalla
            if (typeof instruccionesActivas !== 'undefined' && instruccionesActivas) return;

            if (typeof mode !== 'undefined') { 
                if (mode === 'grid') {
                    // MODO EMOCIONES: Mover selección de los botones centrales
                    moverSeleccion(delta);
                    
                    // (Opcional) Mantener lógica de cursor si la usas visualmente
                    if(typeof currentCol !== 'undefined' && typeof COLS !== 'undefined'){
                        currentCol = clampMod(currentCol + delta, COLS);
                        updateCursor(); 
                    }

                } else if (mode === 'rightbar') {
                    // MODO BARRA LATERAL
                    rightBarIndex = clampMod(rightBarIndex + delta, rightBarImgs.length);
                    updateRightbarFocus(); 
                }
            } 
        }
    });
</script>

<script>

const padGrid = document.getElementById('padGrid');
const stackArea = document.getElementById('stackArea');
const rightBar = document.getElementById('rightBar');
const rightBarImgs = rightBar.querySelectorAll('img');

const ROWS = 4, COLS = 3;
let currentRow = 0, currentCol = 0;
let mode = 'grid'; // "grid" o "rightbar"
let rightBarIndex = 0;

const labels = [
  ['Guitarra 1','Guitarra 2','Guitarra 3'],
  ['Bateria 1','Bateria 2','Bateria 3'],
  ['Piano 1','Piano 2','Piano 3'],
  ['Voz 1','Voz 2','Voz 3']
];

let audioCtx = null;
function ensureAudio(){ if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); } }

const selected=[null,null,null,null];
const padImages=[
  ['Diseño/Property 1=Frame 1.png','Diseño/Property 1=Frame 2.png','Diseño/Property 1=Frame 13.png'],
  ['Diseño/Component 24.png','Diseño/Component 25.png','Diseño/Component 26.png'],
  ['Diseño/Component 27.png','Diseño/Component 28.png','Diseño/Component 29.png'],
  ['Diseño/Component 30.png','Diseño/Component 31.png','Diseño/Component 32.png']
];

function buildGrid(){
  padGrid.innerHTML='';
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const el=document.createElement('div');
      el.className='pad';
      el.style.backgroundImage=`url('${padImages[r][c]}')`;
      el.style.backgroundSize='cover';
      el.style.backgroundPosition='center';
      el.dataset.row=r; el.dataset.col=c;
      el.innerHTML=`<div class="label">${labels[r][c]}</div>`;
      el.addEventListener('click',()=>{ currentRow=r; currentCol=c; updateCursor(); selectCurrent(); });
      padGrid.appendChild(el);
    }
  }
  updateCursor(); refreshSelectionsUI();
}

function getPadElement(row,col){ return padGrid.children[row*COLS+col]; }

function updateCursor(){
  Array.from(padGrid.children).forEach(el=>el.classList.remove('cursor'));
  if(mode==='grid'){
    const el=getPadElement(currentRow,currentCol);
    if(el) el.classList.add('cursor');
  }
}

function clampMod(v,mod){ return ((v%mod)+mod)%mod; }

const rightBarImgsArr = Array.from(rightBarImgs);
function updateRightbarFocus(){
  rightBarImgsArr.forEach((img,i)=>img.classList.toggle('focused',i===rightBarIndex));
}

// --- Botones de emociones ---
let instruccionesActivas = false;
let modoBotones = 'activo';
let indice = 0;
const botones = document.querySelectorAll('.boton');
botones[indice].classList.add('seleccionado');

function updateBotonesVisual(){
  if(mode==='grid'){
    botones.forEach((b,i)=>{
      b.classList.toggle('seleccionado', i===indice);
    });
  } else {
    // Rightbar: remover explícitamente todos los .seleccionado
    botones.forEach(b=>{
      b.classList.remove('seleccionado');
    });

    // Reset de índice para que no quede ninguno marcado
    indice = -1;
  }
}


// --- Función mover selección ---
function moverSeleccion(dir){
  if(mode!=='grid') return;
  indice = (indice + dir + botones.length)%botones.length;
  updateBotonesVisual();
}

// --- Alternar modo ---
function setMode(newMode){
  mode = newMode;
  if(mode==='grid'){
    updateCursor();
  } else if(mode==='rightbar'){
    updateCursor();
    updateRightbarFocus();
  }
  updateBotonesVisual();
}

// --- Scroll para grid y rightbar ---
window.addEventListener('wheel', e => {
  if (!instruccionesActivas) {
    if(mode==='grid'){
      moverSeleccion(e.deltaY>0?1:-1);
      currentCol = clampMod(currentCol + (e.deltaY>0?1:-1), COLS);
      updateCursor();
    } else if(mode==='rightbar'){
      rightBarIndex = clampMod(rightBarIndex + (e.deltaY>0?1:-1), rightBarImgs.length);
      updateRightbarFocus();
    }
    e.preventDefault();
  }
}, {passive:false});

// --- Botón central y teclas ---
const loop = document.querySelector('.loop');
window.addEventListener('keydown', e => {
  const key = e.key.toLowerCase();

  if(instruccionesActivas){
    loop.style.transition = 'opacity 0.5s ease';
    loop.style.opacity = '0';
    setTimeout(()=>{loop.style.display='none'; instruccionesActivas=false;},500);
  }

  if(mode==='grid'){
    if(key==='v'){ currentRow=clampMod(currentRow+1,ROWS); updateCursor(); }
    if(key==='1'){ currentRow=clampMod(currentRow-1,ROWS); updateCursor(); }
    if(key==='s'){ moverSeleccion(1); }
    if(key==='w'){ moverSeleccion(-1); }
  } else if(mode==='rightbar'){
    if(key==='v'){ rightBarIndex=clampMod(rightBarIndex+1,rightBarImgs.length); updateRightbarFocus(); }
    if(key==='1'){ rightBarIndex=clampMod(rightBarIndex-1,rightBarImgs.length); updateRightbarFocus(); }
  }

  if(key==='x'){ setMode(mode==='grid'?'rightbar':'grid'); }
});

// --- Manejo tecla J corto/largo ---
let jTimeout = null;
let jPressedTime = 0;
const jHoldThreshold = 2000;

window.addEventListener('keydown', e => {
  const key = e.key.toLowerCase();
  if(key==='+' && !jTimeout){
    jPressedTime=Date.now();
    jTimeout = setTimeout(()=>{ setMode(mode==='grid'?'rightbar':'grid'); jTimeout=null; }, jHoldThreshold);
  }
});

window.addEventListener('keyup', e => {
  const key = e.key.toLowerCase();
  if(key==='+'){
    if(jTimeout){
      clearTimeout(jTimeout);
      jTimeout=null;
      const holdTime = Date.now()-jPressedTime;
      if(holdTime<jHoldThreshold){
        if(mode==='grid'){
          const destino = ['emociones1.html','emociones1.html','emociones1.html'][indice];
          window.location.href = destino;
        } else if(mode==='rightbar'){
          const target = rightBarImgs[rightBarIndex];
          if(target){
            const parentLink = target.closest('a');
            if(parentLink && parentLink.getAttribute('href') && parentLink.getAttribute('href')!=='#'){
              window.location.href = parentLink.getAttribute('href');
            } else {
              activateRightbarItem();
            }
          }
        }
      }
    }
  }
});

function activateRightbarItem(){
  const target = rightBarImgs[rightBarIndex];
  if(!target) return;
  console.log('Seleccionaste:', target.src);
  target.style.transform='scale(1.2)';
  setTimeout(()=>updateRightbarFocus(),200);
}

// --- Inicialización ---
buildGrid();
document.querySelector('.container').addEventListener('click',()=>document.querySelector('.container').focus());
updateRightbarFocus();
updateBotonesVisual();
</script>

<script>
  window.addEventListener('keydown', (e) => {
    const key = e.key.toLowerCase();
    
    // Si la tecla presionada es 'e'
    if (key === 'e') {
        // Redirige a la página principal
        window.location.href = 'nucleo11.html';
    }
});
</script>
</body>
</html>
